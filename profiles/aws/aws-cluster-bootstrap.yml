parents:
  - aws-config

pre_run:
  cenv-host:
    command: host rm

pre_destroy:
  cenv-host:
    command: host rm

profile:
  base-network:
    module: cluster
    profile: aws-network
    operations: run

  cenv-network:
    requires: base-network
    profile: aws-network

  cenv-admin:
    requires: cenv-network
    profile: aws-server
    deploy_cenv: true

  percona-cluster:
    requires: cenv-admin
    host: "@admin_server_host_name"
    module: percona
    profile: aws-cluster

  cenv-cluster:
    requires: percona-cluster
    host: "@admin_server_host_name"
    profile: aws-cluster
    deploy_cenv: true

post_run:
  cenv-host:
    command: host save
    host_fields:
      host: "@{admin_cluster_name}-@environment.@root_domain"

  cenv-admin-rotate:
    command: user rotate
    host: "@admin_server_host_name"

  cenv-cluster-rotate:
    requires: cenv-host
    command: user rotate

post_destroy:
  cenv-admin-host:
    command: host rm
    host_name: "@admin_server_host_name"
