parents:
  - module: cluster
    profile: aws-config

  - aws-config

post_run:
  mcmi-credentials:
    command: server rotate

  mcmi-user-environment:
    requires: mcmi-credentials
    module: cluster
    task: user-environment

  mcmi-app-environment:
    requires: mcmi-credentials
    task: environment
    env:
      MCMI_DEFAULT_ENV_NAME: "@environment"
      MCMI_DEFAULT_HOST_NAME: "@DEFAULT_HOST_NAME"
      MCMI_DEFAULT_RUNTIME_REPO: "@DEFAULT_RUNTIME_REPO"
      MCMI_DEFAULT_RUNTIME_IMAGE: "@DEFAULT_RUNTIME_IMAGE"
      MCMI_SECRET_KEY: "%%mcmi_secret_key:50"
      MCMI_PARALLEL: "@admin_parallel"
      MCMI_THREAD_COUNT: "@admin_thread_count"
      MCMI_TIME_ZONE: "@primary_timezone"
      MCMI_CORE_MODULE: "@CORE_MODULE"
      MCMI_DEFAULT_MODULES: "@>DEFAULT_MODULES"
      MCMI_DB_PACKAGE_ALL_NAME: "@DB_PACKAGE_ALL_NAME"
      MCMI_DB_MAX_CONNECTIONS: "@admin_db_max_connections"
      MCMI_LOG_LEVEL: "@LOG_LEVEL"
      MCMI_ALLOWED_HOSTS: "@ALLOWED_HOSTS"
      MCMI_ADMIN_USER: "@ADMIN_USER"
      MCMI_DEFAULT_ADMIN_TOKEN: "@DEFAULT_ADMIN_TOKEN"
      MCMI_TERRAFORM_MAX_PROCESSES: "@admin_terraform_max_processes"
      MCMI_ANSIBLE_MAX_PROCESSES: "@admin_ansible_max_processes"

  mcmi-cluster:
    requires: mcmi-app-environment
    task: bootstrap
    ntp_timezone: "@primary_timezone"
    app_user: "@aws_ubuntu_user"
    docker_users:
      - "@aws_ubuntu_user"

  mcmi-wait:
    when: "@deploy_mcmi"
    requires: mcmi-cluster
    module: cluster
    task: wait
    wait_port: "@admin_port"
    timeout: 600

  deploy-mcmi:
    when: "@deploy_mcmi"
    requires: mcmi-wait
    command: deploy
